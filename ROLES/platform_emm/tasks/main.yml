---
# tasks file for master
- name: Load variable file
  include_vars: emm.yml
- name: Update the hostname
  #hostname: name=emm1-001
  shell: sudo hostnamectl set-hostname {{ hostname }}
- name: Get EM20 Installation Tool version
  shell: ls -td CXP* | head -1
  register: version  
- name: Go to template path & create platform nfs ini
  shell:
    chdir: ./{{ version.stdout }}/templates/Linux
    cmd: cp -p platform_cluster_nfs.ini.eric platform_cluster_nfs.ini
- name: Copy the platform script
  copy: src=Install_Platform.sh dest=./{{ version.stdout }}/ backup=yes
#- name: Copy hosts file
#  copy: src=hosts dest=/etc/hosts backup=yes
- name: Update hosts file
  shell: sudo chmod 666 /etc/hosts; sudo echo "{{ bonding_interface_ip_ONM }} {{ hostname }}" >> /etc/hosts; sudo chmod 644 /etc/hosts
- name: Update the cps ini file for ONM Bond
  ini_file:
    path: ./{{ version.stdout }}/templates/Linux/platform_cluster_nfs.ini
    section: ONM Bond
    option: bonding_interface_primary_ONM
    value: "{{ bonding_interface_primary_ONM }}"
    no_extra_spaces: yes
- name: Update the nfs ini file for Interface IP
  ini_file:
    path: ./{{ version.stdout }}/templates/Linux/platform_cluster_nfs.ini
    section: Interface IP
    option: "{{item.key}}"
    value: "{{item.value}}"
    no_extra_spaces: yes
  with_dict: {bonding_interface_ip_ONM: "{{ bonding_interface_ip_ONM }}",netmask_ONM: "{{ netmask_ONM }}",default_gateway_ip_ONM: "{{ default_gateway_ip_ONM }}"}
- name: Update the nfs ini file for CLUSTER
  ini_file:
    path: ./{{ version.stdout }}/templates/Linux/platform_cluster_nfs.ini
    section: Cluster
    option: "{{item.key}}"
    value: "{{item.value}}"
    no_extra_spaces: yes
  with_dict: {Cluster_ID: "{{ Cluster_ID }}",Cluster_Name: "{{ Cluster_Name }}",HeartBeat_Link_1: "{{ HeartBeat_Link_1 }}",HeartBeat_Link_2: "{{ HeartBeat_Link_2 }}",IO_Fencing_Type: "{{ IO_Fencing_Type }}",NFS_Server_Version_for_MMDB: "{{ NFS_Server_Version_for_MMDB }}",NFS_Share_IP_for_MMDB: "{{ NFS_Share_IP_for_MMDB }}",MMDB_NFS_Share_Name: "{{ MMDB_NFS_Share_Name }}",NFS_Server_Version_for_MMStorage: "{{ NFS_Server_Version_for_MMStorage }}",NFS_Share_IP_for_MMStorage: "{{ NFS_Share_IP_for_MMStorage }}",MMStorage_NFS_Share_Name: "{{ MMStorage_NFS_Share_Name }}",other_hosts_ONM: "{{ other_hosts_ONM }}"}
- name: Copy automation script
  copy: src=install_updated.sh dest=./{{ version.stdout }}/
- name: Copy the cps libfunc script
  copy: src=libfunc_cps_platform.sh dest=./{{ version.stdout }}/lib/Linux/ backup=yes
- name: Copy the cps.txt file with the CPS IPs (required by libfunc_cps_platform.sh)
  shell: sudo cp -p cps.txt /etc/cp_server_ip
- name: Execute the EMM platform script
  shell: sh ./{{ version.stdout }}/install_updated.sh
  ignore_errors: true
  ignore_unreachable: true
    
 
